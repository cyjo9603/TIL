# 가비지 컬렉션

- 자바스크립트는 눈에 보이지 않는 곳에서 메모리 관리를 수행한다.
- 원시값, 객체, 함수 등 우리가 만드는 모든 것은 메모리를 차지한다.
- 가비지 컬렉션은 더는 쓸모 없어지게 된 값들을 찾아내 메모리 관리를 수행하는 작업을 말한다.

## 가비지 컬렉션 기준

- 자바스크립트는 도달 가능성(reachability)이라는 개념을 사용해 메모리 관리를 수행한다.
- 도달 가능한 값은 쉽게 말해 어떻게든 접근하거나 사용할 수 있는 값을 의미한다.
- 도달 가능한 값은 메모리에서 삭제되지 않는다.

### 루트 값

- 루트 값은 태생부터 도달 가능하기 때문에 명백한 이유 없이는 삭제되지 않는다.
    - 현재 함수의 지역 변수와 매개변수
    - 중첩 함수의 체인에 있는 함수에서 사용되는 변수와 매개변수
    - 전역 변수
- 루트가 참조하는 값이나 체이닝으로 루트에서 참조할 수 있는 값은 도달 가능한 값이 된다

### 가비지 컬렉터

- 자바스크립트 엔진 내에선 가비지 컬렉터가 끊임없이 동작한다.
- 가비지 컬렉터는 모든 객체를 모니터링하고, 도달할 수 없는 객체는 삭제한다.

### 참조 두개

```jsx
let user = {
	name: 'John',
};

let admin = user;
user = null;
```

- `admin`과 `user`가 같은 객체를 참조하고 있을 때 `user`의 값을 다른 값으로 덮어씌워도 `admin`을 통해 객체를 참조할 수 있기 때문에 `'John'`은 메모리에서 삭제되지 않는다.
- 이 상태에서 `admin`을 다른 값으로 덮어쓰면 `'John'`은 메모리에서 삭제될 수 있습니다.

### 연결된 객체

```jsx
function marry(man, woman) {
	woman.husband = man;
	man.wife = woman;

	return {
		father: man,
		mother: woman
	}
}

let family = marry({
	name: 'John'
}, {
	name: 'Ann'
});
```

![Untitled%20d0b67dd342734305aae5c6966fc1ffc0/Untitled.png](Untitled%20d0b67dd342734305aae5c6966fc1ffc0/Untitled.png)

- 다음은 소스의 메모리 구조이다.
- 함수 `marry`는 매개변수로 받은 두 객체를 서로 참조하게 하면서 결혼시키고, 두 객체를 포함하는 새로운 객체를 반환한다.

- 현재는 모든 객체가 도달 가능한 상태이다.

```jsx
delete family.father;
delete family.mother.husband;
```

- `'John'`을 참조하는 속성 두가지를 제거했다.

![Untitled%20d0b67dd342734305aae5c6966fc1ffc0/Untitled%201.png](Untitled%20d0b67dd342734305aae5c6966fc1ffc0/Untitled%201.png)

- 삭제한 두 개의 참조 중 하나만 지웠다면, 모든 객체가 여전이 도달 가능한 상태이다.
- 하지만 참조 두 개를 지우면 `'John'`으로 들어오는 참조는 모두 사라져 `'John'`은 도달 가능한 상태에서 벗어난다.

![Untitled%20d0b67dd342734305aae5c6966fc1ffc0/Untitled%202.png](Untitled%20d0b67dd342734305aae5c6966fc1ffc0/Untitled%202.png)

# →

![Untitled%20d0b67dd342734305aae5c6966fc1ffc0/Untitled%203.png](Untitled%20d0b67dd342734305aae5c6966fc1ffc0/Untitled%203.png)

- 외부로 나가는 참조는 도달 가능한 상태에 영향을 주지 않는다.
- 외부에서 들어오는 참조만이 도달 가능한 상태에 영향을 주기 때문에 `'John'`은 메모리에서 사라진다.

### 도달할 수 없는 섬

- 객체들이 연결되어 섬 같은 구조를 만드는데, 이 섬에 도달할 방법이 없는 경우, 섬을 구성하는 객체 전부가 메모리에서 삭제된다.

## 내부 알고리즘 (mark-and-sweep)

- 'mark-and-sweep'은 가비지 컬렉션 기본 알고리즘이다.
- 가비지 컬렉션은 대개다음 단계를 거쳐 수행된다.
    1. 가지비 컬렉터는 루트 정보를 수집하고 이를 mark(기억)한다.
    2. 루트가 참조하고 있는 모든 객체를 방문하고 이것들을 mark한다.
    3. mark된 모든 객체에 방문하고 그 객체들이 참조하는 객체도 mark한다. 한번 방문한 객체는 전부 mark하기 때문에 같은 객체를 다시 방문하는 일은 없다.
    4. 루트에서 도달 가능한 모든 객체를 방문할 때까지 위 과정을 반복한다.
    5. mark되지 않은 모든 객체를 메모리에서 삭제한다.

## 최적화 기법

- 자바스크립트 엔진은 실행에 영향을 미치지 않으면서 가비지 컬렌션을 더 빠르게 하는 다양한 최적화 기법을 적용한다.

### generational collection (세대별 수집)

- 객체를 '새로운 객체'와 '오래된 객체'로 나눠진다.
- 객체 상당수는 생성 이후 제 역할을 빠르게 수행해 금방 쓸모가 없어지는데, 이런 객체를 '새로운 객체'로 구분한다.
- 기비지 컬렉터는 이런 객체를 공격적으로 메모리에서 제거한다.
- 일정 시간 이상 동안 살아남은 객체는 '오래된 객체'로 분류하고, 가비지 컬렌터가 덜 감시한다.

### incremental collection (점진적 수집)

- 방문해야 할 객체가 많다면 모든 객체를 한번에 방문하고 mark하는데 상당한 시간이 소모된다.
- 그렇게 되면 가비지 컬렉션에 많은 리소스가 사용되어 실행 속도도 눈에 띄게 느려진다.
- 자바스크립트 엔진은 이런 현상을 개선하기 위해 가비지 컬렉션을 여러 부분으로 분리한 다음, 각 부분을 별도로 수행한다.
- 작업을 분리하고, 변경 사항을 추적하는 데 추가 작업이 필요하긴 하지만, 긴 지연을 짧은 지연 여러개로 분산시킬 수 있다는 장점이 있다.

### idle-time collection (유휴 시간 수집)

- 가비지 컬렉터는 실행에 주는 영향을 최소화하기 위해 CPU가 유휴 상태일 때만 가비지 컬렉션을 실행한다.

### 참고

[JAVASCRIPT.INFO - 참조에 의한 객체 복사](https://ko.javascript.info/garbage-collection)